<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Advanced Web AR - –¢–æ—á–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤</title>
    
    <!-- A-Frame –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- AR.js –¥–ª—è –≤–µ–±-AR -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
    
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è AR -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <!-- Physics system –¥–ª—è A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à–∏ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="style.css">
    
    <style>
        .webxr-info {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 200px;
            z-index: 998;
            backdrop-filter: blur(10px);
        }
        
        .calibration-helper {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 193, 7, 0.9);
            color: black;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            z-index: 997;
            display: none;
        }
        
        .surface-detected {
            background: rgba(40, 167, 69, 0.9) !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingIndicator">
        <div>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Advanced AR...</div>
        <div>–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebXR</div>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ WebXR -->
    <div class="webxr-info" id="webxrInfo" style="display: none;">
        <div><strong>WebXR AR</strong></div>
        <div id="webxrStatus">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É...</div>
    </div>
    
    <!-- UI –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="ui-overlay">
        <div><strong>Advanced Web AR</strong></div>
        <div id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        <div style="margin-top: 10px; font-size: 12px;">
            ‚Ä¢ <span id="trackingMode">–ë–∞–∑–æ–≤–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ</span><br>
            ‚Ä¢ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —Ä–æ–≤–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å<br>
            ‚Ä¢ –ò—â–∏—Ç–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è<br>
            ‚Ä¢ –û–±—ä–µ–∫—Ç—ã —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è —Ç–æ—á–Ω–æ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
        </div>
    </div>
    
    <!-- –ü–æ–º–æ—â–Ω–∏–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ -->
    <div class="calibration-helper" id="calibrationHelper">
        <div>üéØ –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞!</div>
        <div>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞</div>
    </div>
    
    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="controls">
        <button class="btn" id="addCube" disabled>üü• –ö—É–±</button>
        <button class="btn" id="addSphere" disabled>üîµ –°—Ñ–µ—Ä–∞</button>
        <button class="btn" id="addCylinder" disabled>üü¶ –¶–∏–ª–∏–Ω–¥—Ä</button>
        <button class="btn" id="clearObjects">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn" id="calibrateBtn" style="background: #ffc107;">üìê –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</button>
    </div>

    <!-- AR —Å—Ü–µ–Ω–∞ —Å —Ñ–∏–∑–∏–∫–æ–π -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; antialias: true;"
        physics="driver: ammo; debug: false; debugDrawMode: 0;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        background="color: transparent;">
        
        <!-- –ê—Å—Å–µ—Ç—ã -->
        <a-assets>
            <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å PBR -->
            <a-mixin id="cube-material" 
                     material="color: #ff6b6b; metalness: 0.3; roughness: 0.7; envMap: #env;">
            </a-mixin>
            
            <a-mixin id="sphere-material" 
                     material="color: #4ecdc4; metalness: 0.5; roughness: 0.6; envMap: #env;">
            </a-mixin>
            
            <a-mixin id="cylinder-material" 
                     material="color: #45b7d1; metalness: 0.2; roughness: 0.8; envMap: #env;">
            </a-mixin>
            
            <!-- –¢–µ–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ -->
            <a-cubemap id="env" 
                       src="https://cdn.aframe.io/examples/sky/environment/pisa-posx.jpg https://cdn.aframe.io/examples/sky/environment/pisa-negx.jpg https://cdn.aframe.io/examples/sky/environment/pisa-posy.jpg https://cdn.aframe.io/examples/sky/environment/pisa-negy.jpg https://cdn.aframe.io/examples/sky/environment/pisa-posz.jpg https://cdn.aframe.io/examples/sky/environment/pisa-negz.jpg">
            </a-cubemap>
            
            <!-- –ó–≤—É–∫–∏ -->
            <audio id="placeSound" preload="auto">
                <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmIlBjuJzPPIeS0GK4DN8tiKOQceXKvn5K5VDQxNpOPvq2cjEjOI0O6+ciMFKYLL8ODMeSgPZ7no3q4+DRVGl9n1vpgiAZ9yWrg=" type="audio/wav">
            </audio>
        </a-assets>
        
        <!-- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ -->
        <a-light type="ambient" color="#404040" intensity="0.6"></a-light>
        <a-light type="directional" 
                 color="#ffffff" 
                 intensity="1.0" 
                 position="0 10 5"
                 shadow="cast: true; mapSize: 2048;">
        </a-light>
        <a-light type="point" 
                 color="#4fc3f7" 
                 intensity="0.5" 
                 position="0 3 0">
        </a-light>
        
        <!-- AR –∫–∞–º–µ—Ä–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º -->
        <a-camera 
            gps-camera 
            rotation-reader 
            id="arCamera"
            look-controls-enabled="false"
            arjs-look-controls="smoothingFactor: 0.1"
            position="0 1.6 0">
            
            <!-- –ö—É—Ä—Å–æ—Ä —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π -->
            <a-cursor 
                id="cursor"
                animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                animation__fusing="property: fusing; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
                raycaster="objects: .interactive; far: 20; near: 0;"
                geometry="primitive: ring; radiusOuter: 0.020; radiusInner: 0.012;"
                material="color: #4fc3f7; shader: flat; opacity: 0.8; transparent: true;"
                position="0 0 -1">
            </a-cursor>
        </a-camera>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Ñ–∏–∑–∏–∫–æ–π -->
        <a-entity id="objectContainer" 
                  static-body="shape: none;">
        </a-entity>
        
        <!-- –ù–µ–≤–∏–¥–∏–º–∞—è –ø–ª–æ—Å–∫–æ—Å—Ç—å –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –ø–æ–ª–∞ -->
        <a-plane 
            id="groundPlane"
            position="0 -1 0" 
            rotation="-90 0 0" 
            width="100" 
            height="100" 
            material="opacity: 0; transparent: true;"
            static-body="shape: box;"
            visible="false">
        </a-plane>
    </a-scene>

    <!-- –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—ã–π AR -->
    <script src="ar-app.js"></script>
    <!-- –ó–∞—Ç–µ–º –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π AR -->
    <script src="advanced-ar.js"></script>
    
    <script>
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        document.addEventListener('DOMContentLoaded', () => {
            const webxrInfo = document.getElementById('webxrInfo');
            const webxrStatus = document.getElementById('webxrStatus');
            const trackingMode = document.getElementById('trackingMode');
            const calibrationHelper = document.getElementById('calibrationHelper');
            const calibrateBtn = document.getElementById('calibrateBtn');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ WebXR
            webxrInfo.style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å WebXR
            setTimeout(() => {
                if (window.arApp && window.arApp.isWebXRSupported) {
                    webxrStatus.textContent = '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚úÖ';
                    trackingMode.textContent = 'WebXR –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ';
                } else {
                    webxrStatus.textContent = '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚ùå';
                    trackingMode.textContent = 'AR.js –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ';
                }
            }, 2000);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
            calibrateBtn.addEventListener('click', () => {
                if (window.arApp && window.arApp.calibrateSurfaceTracking) {
                    window.arApp.calibrateSurfaceTracking();
                    calibrationHelper.style.display = 'block';
                    setTimeout(() => {
                        calibrationHelper.style.display = 'none';
                    }, 3000);
                }
            });
            
            // –°–∏–º—É–ª—è—Ü–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
            setInterval(() => {
                if (window.arApp && window.arApp.isInitialized) {
                    const hasObjects = window.arApp.objects.length > 0;
                    if (hasObjects && Math.random() > 0.7) {
                        calibrationHelper.classList.add('surface-detected');
                        calibrationHelper.style.display = 'block';
                        setTimeout(() => {
                            calibrationHelper.style.display = 'none';
                            calibrationHelper.classList.remove('surface-detected');
                        }, 2000);
                    }
                }
            }, 5000);
        });
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ AR
        window.ARUtils = {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            checkTrackingQuality() {
                if (window.arApp) {
                    const info = window.arApp.getObjectsInfo();
                    console.log('–ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:', {
                        objects: info.total,
                        anchored: info.objects.filter(obj => obj.anchored).length,
                        webxr: window.arApp.isWebXRSupported
                    });
                }
            },
            
            // –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–∑–∏—Ü–∏–π –æ–±—ä–µ–∫—Ç–æ–≤
            exportObjectPositions() {
                if (window.arApp) {
                    const positions = window.arApp.objects.map(obj => ({
                        id: obj.id,
                        type: obj.type,
                        position: obj.position,
                        timestamp: obj.timestamp
                    }));
                    
                    const json = JSON.stringify(positions, null, 2);
                    console.log('–ü–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤:', json);
                    
                    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
                    localStorage.setItem('ar-objects', json);
                    
                    return json;
                }
            },
            
            // –ò–º–ø–æ—Ä—Ç –ø–æ–∑–∏—Ü–∏–π –æ–±—ä–µ–∫—Ç–æ–≤
            importObjectPositions() {
                const saved = localStorage.getItem('ar-objects');
                if (saved && window.arApp) {
                    const positions = JSON.parse(saved);
                    positions.forEach(obj => {
                        window.arApp.placeObject(obj.type, obj.position);
                    });
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${positions.length} –æ–±—ä–µ–∫—Ç–æ–≤`);
                }
            }
        };
    </script>
</body>
</html> 